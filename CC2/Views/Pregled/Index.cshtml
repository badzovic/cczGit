@model CC2.Models.Pregled

@{
    ViewBag.Title = "Pregled";
}


<main class="main-content position-relative border-radius-lg ">
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="card">

                    <!-- Card header -->
                    <div class="card-header">
                        @if (User.IsInRole("adminsales"))
                        {
                            <h5 class="mb-0">Pregled novih karti</h5>
                        }
                        else
                        {
                            <h5 class="mb-0">Pregled</h5>
                        }


                    </div>
                    @if (TempData["Success"] != null)
                    {
                        <div style="margin-left:23px;" id="successPopup" class="custom-popup">
                            <span style="color:green;" class="custom-popup-content">@TempData["Success"]</span>


                        </div>
                    }
                    @if (TempData["Error"] != null)
                    {
                        <div style="margin-left:23px;" id="errorPopup" class="custom-popup">
                            <span style="color:darkred;" class="custom-popup-content">@TempData["Error"]</span>


                        </div>
                    }
                    <div class="table-responsive">

                        <table class="table table-flush" id="datatable-basic">

                            <thead class="thead-light">

                                <tr style="text-align:center;">


                                    @if (User.IsInRole("marketing"))
                                    {
                                        <p style="margin-left:25px;">  <input type="checkbox" id="selectAll" />  Odaberi sve unose</p>

                                        <th></th>

                                        <th>Rb</th>

                                        <th>Firma</th>

                                        <th>Broj kartica</th>

                                        <th>Adresa</th>

                                        <th>PLZ</th>

                                        <th>Drzava</th>

                                        <th>Broj</th>

                                        <th>Datum</th>

                                        <th>termin</th>

                                        <th>Pregledaj</th>

                                        <th>Akcija</th>
                                    }
                                    @if (User.IsInRole("adminmarketing"))
                                    {

                                        <p style="margin-left:25px;">  <input type="checkbox" id="selectAll" />  Odaberi sve unose</p>

                                        <th></th>

                                        <th>Rb</th>

                                        <th>Firma</th>

                                        <th>Broj kartica</th>

                                        <th>Adresa</th>

                                        <th>PLZ</th>

                                        <th>Drzava</th>

                                        <th>Broj</th>

                                        <th>Kreirao</th>

                                        <th>Datum</th>

                                        <th>termin</th>


                                        <th>Pregledaj</th>



                                    }
                                    @if (User.IsInRole("kontrola"))
                                    {
                                        <p style="margin-left:25px;">  <input type="checkbox" id="selectAll" />  Odaberi sve unose</p>

                                        <th></th>

                                        <th>Rb</th>

                                        <th>Firma</th>

                                        <th>Broj kartica</th>

                                        <th>Adresa</th>

                                        <th>PLZ</th>

                                        <th>Drzava</th>

                                        <th>Kreirao</th>

                                        <th>Broj</th>

                                        <th>Datum</th>

                                        <th>termin</th>


                                        <th>Pregledaj</th>

                                    }
                                    @if (User.IsInRole("adminsales"))
                                    {
                                        <p style="margin-left:25px;">  <input type="checkbox" id="selectAll" />  Odaberi sve unose</p>

                                        <th></th>

                                        <th>Rb</th>

                                        <th>Firma</th>

                                        <th>Broj kartica</th>

                                        <th>Adresa</th>



                                        <th>Drzava</th>

                                        <th>Broj tel</th>

                                        <th>Datum</th>
                                        <th>Kreirao</th>

                                        <th>termin</th>





                                        <th>Pregledaj</th>


                                    }
                                    @if (User.IsInRole("sales"))
                                    {
                                        <th>Rb</th>

                                        <th>Firma</th>

                                        <th>Broj kartica</th>

                                        <th>Adresa</th>

                                        <th>Drzava</th>

                                        <th>Broj</th>

                                        <th>Datum</th>

                                        <th>Termin</th>

                                    }
                                </tr>

                            </thead>

                            @if (User.IsInRole("marketing"))
                            {
                                <tbody>
                                    @foreach (var item in Model.kontaktiMarketing)
                                    {
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="select-checkbox" data-id="@item.ID" />
                                            </td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.ID</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.FIRMA</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.BROJ_KARTICA</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.ADRESA</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.PLZ</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.DRZAVA</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.PREFIX @item.BROJ</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.DATETIME_CREATED</td>
                                            <td>
                                                <a href="@Url.Action("Kalendar", "Kontakti", new { id = item.ID })" class="btn btn-sm btn-outline-primary">
                                                    📅 Termini
                                                </a>
                                            </td>
                                            <td>
                                                <a class="btn btn_primary text-uppercase linkForItem" href="@Url.Action("Kontakt", "Pregled", new { id = item.ID })">PREGLED</a>

                                            </td>



                                        </tr>

                                    }
                                </tbody>
                            }
                            @if (User.IsInRole("adminmarketing"))
                            {
                                <tbody>
                                    @foreach (var item in Model.kontaktiAdminMarketing)
                                    {
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="select-checkbox" data-id="@item.ID" />
                                            </td>
                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.ID</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.IME</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.PREZIME</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.ADRESA</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.PLZ</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.DRZAVA</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.PREFIX @item.BROJ</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.AspNetUsers.UserName</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.DATETIME_CREATED</td>

                                            <td>
                                                <a class="btn btn_primary text-uppercase" href="@Url.Action("Kontakt", "Pregled", new { id = item.ID})">PREGLED</a>
                                            </td>



                                        </tr>

                                    }

                                </tbody>
                            }
                            @if (User.IsInRole("kontrola"))
                            {
                                <tbody>
                                    @foreach (var item in Model.kontrola)
                                    {
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="select-checkbox" data-id="@item.ID" />
                                            </td>
                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.ID</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.IME</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.PREZIME</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.ADRESA</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.PLZ</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.DRZAVA</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.AspNetUsers.UserName</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.PREFIX @item.BROJ</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.DATETIME_CREATED</td>

                                            <td>
                                                <a class="btn btn_primary text-uppercase" href="@Url.Action("Kontakt", "Pregled", new { id = item.ID})">PREGLED</a>
                                            </td>


                                        </tr>

                                    }
                                </tbody>
                            }
                            @if (User.IsInRole("adminsales"))
                            {
                                <tbody>
                                    @foreach (var item in Model.kontaktiSalesAdmin)
                                    {
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="select-checkbox" data-id="@item.ID" />
                                            </td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.ID</td>
                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.FIRMA</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.BROJ_KARTICA</td>


                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.ADRESA</td>


                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.DRZAVA</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.PREFIX @item.BROJ</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.DATETIME_CREATED</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.AspNetUsers.UserName</td>

                                            <td>
                                                <a href="@Url.Action("Kalendar", "Kontakti", new { id = item.ID })" class="btn btn-sm btn-outline-primary">
                                                    📅 Termini
                                                </a>
                                            </td>
                                            <td>
                                                <a class="btn btn-outline-secondary text-uppercase" href="@Url.Action("kontaktSales", "Pregled", new { id = item.ID})">PREGLED</a>
                                            </td>
                                            @*<td>
            <button type="button" class="btn btn-outline-secondary" id="prosljediAgentu" data-item-id="@item.ID">PROSLJEDI AGENTU</button>
        </td>*@
                                        </tr>

                                    }
                                </tbody>
                            }
                            @if (User.IsInRole("sales"))
                            {
                                <tbody>
                                    @foreach (var item in Model.kontaktiSales)
                                    {
                                        <tr>
                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.ID</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.FIRMA</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.BROJ_KARTICA</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.ADRESA</td>


                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.DRZAVA</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.PREFIX @item.BROJ</td>

                                            <td style="text-align:left;" class="text-sm font-weight-bold">@item.DATETIME_CREATED</td>
                                            <td>
                                                <a href="@Url.Action("Kalendar", "Kontakti", new { id = item.ID })" class="btn btn-sm btn-outline-primary">
                                                    📅 Termini
                                                </a>
                                            </td>
                                            


                                            <td>
                                                <a class="btn btn-outline-secondary text-uppercase" href="@Url.Action("kontaktSales", "Pregled", new { id = item.ID})">PREGLED</a>
                                            </td>
                                        </tr>

                                    }
                                </tbody>
                            }
                        </table>
                        @if (User.IsInRole("adminmarketing"))
                        {
                            <div style="display: flex; justify-content: flex-end;">
                                <a id="prosljedi-link-prosljedi-link-vratiMarketingu" class="btn btn-dark" href="#" style="margin-right: 10px;">OZNACI KAO VRACENO</a>
                                <a id="prosljedi-link-vrati" class="btn btn-info" href="#" style="margin-right: 10px;">VRATI AGENTU</a>
                                <a id="prosljedi-link" class="btn btn-danger" href="#" style="margin-right: 10px;">PROSLJEDI KONTROLI</a>
                            </div>
                        }


                        @if (User.IsInRole("marketing"))
                        {
                            <div style="display: flex; justify-content: flex-end;">
                                <a style="margin-right: 10px;" id="prosljedi-link-adminu" class="btn btn-success" href="#">ZAINTERESOVAN</a>
                            </div>

                        }
                        @if (User.IsInRole("kontrola"))
                        {
                            <div style="display: flex; justify-content: flex-end;">
                                <a id="prosljedi-link-prosljedi-link-vratiMarketingu" class="btn btn-info" href="#" style="margin-right: 10px;">VRATI MARKETINGU</a>
                                <a id="prosljedi-link-salesu" class="btn btn-danger" href="#" style="margin-right: 10px;">PROSLJEDI SALESU</a>
                            </div>
                        }
                        @if (User.IsInRole("adminsales"))
                        {
                            <div style="display: flex; justify-content: flex-end;">
                                <button type="button" class="btn btn-outline-primary" style="margin-right: 20px;" id="prosljedi-link-salesAgentu">PROSLJEDI AGENTU</button>
                            </div>
                            @*foreach (var item in Model.kontaktiSalesAdmin)
                                {
                                    <div class="item">
                                         Your item content here
                                         Add a checkbox for each item with a unique value
                                        s
                                        <input type="checkbox" class="select-checkbox" data-id="@item.ID" />
                                    </div>
                                }*@

                        }

                    </div>
                </div>
            </div>
        </div>
    </div>




    <div class="modal fade" id="agentSelectionModal" tabindex="-1" role="dialog" aria-labelledby="agentSelectionModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="agentSelectionModalLabel">Odaberite Agenta</h5>


                </div>
                <div class="modal-body">
                    <form id="agentSelectionForm">
                        <div class="form-group">

                            @Html.DropDownListFor(model => model.SelectedEmail, new SelectList(Model.Users, "Id", "Email"), "Odaberite agenta", new { @class = "form-select", @id = "IdSelect" })

                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="close" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" id="prosljediButton" class="btn btn-primary">Prosljedi</button>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
@*<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.7.0/dist/js/bootstrap.bundle.min.js"></script>*@

<script src="~/Content/js/plugins/datatables.js"></script>
<script>

    var ItemId;
    var selectedIdsSales = []; // Array to store selected item IDs



    $(document).ready(function () {
        var selectedIds = []; // Array to store selected item IDs

        // Handle the click event for the checkboxes
        $(".select-checkbox").click(function () {
            var itemId = $(this).data("id");

            if ($(this).is(":checked")) {
                // If the checkbox is checked, add the item ID to the selectedIds array
                selectedIds.push(itemId);
            } else {
                // If the checkbox is unchecked, remove the item ID from the selectedIds array
                selectedIds = selectedIds.filter(id => id !== itemId);
            }
            console.log(selectedIds);
        });

        $("#selectAll").click(function () {
            var isChecked = $(this).prop("checked");

            // Update the state of all checkboxes to match the "Select All" checkbox
            $(".select-checkbox").prop("checked", isChecked);

            if (isChecked) {
                // Clear the selectedIds array first
                selectedIds = [];

                // Use $.each to iterate over all checkboxes and add their data-id attributes to selectedIds
                $(".select-checkbox").each(function () {
                    selectedIds.push($(this).data("id"));
                    console.log(selectedIds);
                });
            } else {
                // If "Select All" is unchecked, clear the selectedIds array
                selectedIds = [];
            }
        });

        $("#prosljedi-link").click(function () {
            if (selectedIds.length > 0) {

                console.log(selectedIds);

                if (selectedIds.length > 0) {
                    // Construct the URL for the controller action with selectedIds and selectedAgentId
                    var url = "/Pregled/ProsljediKontroli?selectedIds=" + selectedIds.join(",");

                    // Navigate to the controller action
                    window.location.href = url;
                } else {
                    // Display an error message if no agent is selected
                    alert("Molimo odaberite agente.");
                }
            }
        });

        $("#prosljedi-link-salesu").click(function () {
            if (selectedIds.length > 0) {

                console.log(selectedIds);

                if (selectedIds.length > 0) {
                    // Construct the URL for the controller action with selectedIds and selectedAgentId
                    var url = "/Pregled/ProsljediProdaji?selectedIds=" + selectedIds.join(",");

                    // Navigate to the controller action
                    window.location.href = url;
                } else {
                    // Display an error message if no agent is selected
                    alert("Molimo odaberite agente.");
                }
            }
        });

        $(document).on('click', '#prosljedi-link-vrati', function () {
            if (selectedIds.length > 0) {

                console.log(selectedIds);

                if (selectedIds.length > 0) {
                    // Construct the URL for the controller action with selectedIds
                    var url = "/Pregled/VratiAgentu?selectedIds=" + selectedIds.join(",");

                    // Navigate to the controller action
                    window.location.href = url;
                } else {
                    // Display an error message if no agent is selected
                    alert("Molimo odaberite agente.");
                }
            }
        });


        $("#prosljedi-link-prosljedi-link-vratiMarketingu").click(function () {
            if (selectedIds.length > 0) {

                console.log(selectedIds);

                if (selectedIds.length > 0) {
                    // Construct the URL for the controller action with selectedIds and selectedAgentId
                    var url = "/Pregled/VratiMarketingu?selectedIds=" + selectedIds.join(",");

                    // Navigate to the controller action
                    window.location.href = url;
                } else {
                    // Display an error message if no agent is selected
                    alert("Molimo odaberite agente.");
                }
            }
        });



        $("#prosljedi-link-adminu").click(function () {
            if (selectedIds.length > 0) {

                console.log(selectedIds);

                if (selectedIds.length > 0) {
                    // Construct the URL for the controller action with selectedIds and selectedAgentId
                    var url = "/Pregled/Prosljedi?selectedIds=" + selectedIds.join(",");

                    // Navigate to the controller action
                    window.location.href = url;
                } else {
                    // Display an error message if no agent is selected
                    alert("Molimo odaberite agente.");
                }
            }
        });

        $("#prosljedi-link-salesAgentu").click(function () {
            // Clear the selectedIds array
            selectedIdsSales = [];

            // Loop through the checkboxes and add the selected IDs to the array
            $(".select-checkbox:checked").each(function () {
                selectedIdsSales.push($(this).data("id"));
            });
            console.log("sada je selektovano i ide na modal" + selectedIdsSales);
            if (selectedIdsSales.length > 0) {
                // If at least one checkbox is selected, open the modal
                $("#agentSelectionModal").modal("show");
            } else {
                // If no checkboxes are selected, display an error message
                alert("Molimo odaberite stavke koje želite proslijediti agentu.");
            }
        });

        $("#prosljediButton").click(function () {
            var selectedAgentId = $("#IdSelect").val();

            if (selectedAgentId && selectedIdsSales.length > 0) {
                // Construct the URL for the controller action with selectedIds and selectedAgentId
                console.log("iz modala prosljedi" + selectedIdsSales);
                console.log("/Pregled/ProsljediAgentSalesu?selectedIds=" + selectedIdsSales.join(",") + "&selectedAgentId=" + selectedAgentId);
                var url = "/Pregled/ProsljediAgentSalesu?selectedIds=" + selectedIdsSales.join(",") + "&selectedAgentId=" + selectedAgentId;

                // Navigate to the controller action
                window.location.href = url;
            } else if (!selectedAgentId) {
                // Display an error message if no agent is selected
                alert("Molimo odaberite agenta.");
            } else {
                // Display an error message if no items are selected
                alert("Molimo odaberite stavke koje želite proslijediti prodaji.");
            }
        });

        $("#close").click(function () {
            // Show the modal when the link is clicked
            $("#agentSelectionModal").modal("hide");
        });
    });
</script>

<script>

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("izbrisi").addEventListener("click", function () {

            if (selectedIds.length > 0) {
                // Display a confirmation dialog
                var confirmation = confirm("Da li ste sigurni?");

                if (confirmation) {
                    // If the user clicks OK in the confirmation dialog
                    console.log(selectedIds);

                    if (selectedIds.length > 0) {
                        // Construct the URL for the controller action with selectedIds and selectedAgentId
                        var url = "/Pregled/izbrisi?selectedIds=" + selectedIds.join(",");

                        // Navigate to the controller action
                        window.location.href = url;
                    } else {
                        // Display an error message if no agent is selected
                        alert("Molimo odaberite korisnike.");
                    }
                }
            }
        });

    });



</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const dataTable = new simpleDatatables.DataTable("#datatable-basic");

        


        function updateLinkHref(linkElement) {

           
            var savedPage = localStorage.getItem('dataTableCurrentPage');
            const href = linkElement.getAttribute('href');
            const baseUrl = href.substring(0, href.lastIndexOf('/'));
            const id = href.substring(href.lastIndexOf('/') + 1);
            const newHref = `${baseUrl}?id=${id}&page=${savedPage}`;
            linkElement.setAttribute('href', newHref);
        }

    

        // Function to update the console log with the current page
        function updateCurrentPage() {
            const activePageElement = document.querySelector('.dataTable-pagination .active');
            if (activePageElement) {
                // The text content of the active element represents the current page number
                console.log(`Current Page: ${activePageElement.textContent}`);

                localStorage.setItem('dataTableCurrentPage', activePageElement.textContent);

                var savedPage = localStorage.getItem('dataTableCurrentPage');

                console.log(`New Page: ${savedPage}`);
            }
        }

        const paginationContainer = document.querySelector('.dataTable-pagination');
        if (paginationContainer) {
            paginationContainer.addEventListener('click', function (e) {
                // A small timeout to allow the pagination to update
                setTimeout(updateCurrentPage, 10);
            });
        }

        // Attach event listener to each link
        const linkElements = document.querySelectorAll(".linkForItem");
        linkElements.forEach(function (linkElement) {
            linkElement.addEventListener('click', function () {
                updateLinkHref(linkElement);
            });
        });
        // Initial log
        updateCurrentPage();
    });

</script>
