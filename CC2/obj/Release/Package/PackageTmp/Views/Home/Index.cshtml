@model CC2.Models.Dashboard

@{
    ViewBag.Title = "Home";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    @@keyframes blink {
        0% {
            background-color: red;
        }

        50% {
            background-color: transparent;
        }

        100% {
            background-color: red;
        }
    }

    .blinking {
        animation: blink 1s infinite; /* Adjust the animation duration as needed */
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 999; /* Ensure modal is on top of other elements */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4); /* Semi-transparent black background */
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto; /* Center the modal vertically and horizontally */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Set the width of the modal */
        max-width: 600px; /* Optionally limit the maximum width */
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

</style>
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-12">
            <div class="row">
                <div class="col-lg-3 col-md-6 col-12">
                    <div class="card  mb-4">
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-8">
                                    @if (Model.termini != null && Model.termini.Count > 0)
                                    {
                                        var targetDate = Model.termini[0].DATUM;
                                        var currentDate = DateTime.Now;
                                        TimeSpan? timeDifference = (targetDate - currentDate);

                                        <div class="numbers @(timeDifference?.TotalMilliseconds <= 300000 ? "blinking" : "")">
                                            <p class="text-sm mb-0 text-uppercase font-weight-bold">Sljedeći termin</p>
                                            <h5 class="font-weight-bolder ">
                                                @Model.termini[0].NAZIV
                                            </h5>
                                            <p class="mb-0">
                                                <span class="text-success text-sm font-weight-bolder">
                                                    @if (Model.termini[0].DATUM.HasValue)
                                                    {
                                                        string.Format("{0:dd/MM/yyyy HH:mm:ss}", Model.termini[0].DATUM.Value);
                                                    }
                                                </span>
                                            </p>
                                            @if (User.IsInRole("sales"))
                                            {
                                                <a style="text-align: center; font-size: 14px;" href="/Pregled/kontaktSales/@Model.termini[0].KONTAKT_ID"><b style="color: darkslategrey">PREGLEDAJ KONTAKT</b></a>
                                            }
                                            else
                                            {
                                                <a style="text-align: center; font-size: 14px;" href="/Pregled/Kontakt/@Model.termini[0].KONTAKT_ID"><b style="color: darkslategrey">PREGLEDAJ KONTAKT</b></a>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <p>Nemate zakazanih termina.</p>
                                    }
                                </div>
                                <div class="col-4 text-end">
                                    <div class="  icon icon-shape bg-gradient-success shadow-success text-center rounded-circle">
                                        <i class="ni ni-money-coins text-lg opacity-10" aria-hidden="true"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <script>
    function checkAndBlink() {
        // Check if Model.termini has elements and the first element has DATUM
        @if (Model.termini != null && Model.termini.Count > 0)
        {
            <text>
                var targetDate = new Date("@Model.termini[0].DATUM");
                var currentDate = new Date();
                var timeDifference = targetDate - currentDate;
                if (timeDifference @Html.Raw("<=") 300000)
                {
                    // Add the "blinking" class
                    document.getElementById("yourDivId").classList.add("blinking");
                }
            </text>
        }
    }

    // Call the function when the page loads
    window.onload = function() {
        checkAndBlink();
    };
                </script>



                <div class="col-lg-3 col-md-6 col-12">
                    <div class="card  mb-4">
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-8">
                                    <div class="numbers">
                                        <p class="text-sm mb-0 text-uppercase font-weight-bold">Zakazanih termina</p>
                                        <h5 class="font-weight-bolder">
                                            @Model.zakazanihTermina
                                        </h5>
                                        <p class="mb-0">
                                            <span class="text-success text-sm font-weight-bolder">+10%</span>
                                            od prošle sedmice
                                        </p>
                                        <a style="text-align: center; font-size: 14px;" href="/termini"><b style="color: darkslategrey">PREGLEDAJ TERMINE</b></a>

                                    </div>


                                </div>
                                <div class="col-4 text-end">
                                    <div class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle">
                                        <i class="ni ni-paper-diploma text-lg opacity-10" aria-hidden="true"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-12">
                    <div class="card  mb-4">
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-8">
                                    <div class="numbers">
                                        <p class="text-sm mb-0 text-uppercase font-weight-bold">Ukupno vracenih klijenata</p>
                                        <h5 class="font-weight-bolder">
                                            @Model.ukupnoVraceniKlijenti
                                        </h5>
                                        <p class="mb-0">
                                            <span class="text-success text-sm font-weight-bolder">+2%</span> od prošle sedmice
                                        </p>
                                        <a style="text-align:center; font-size:14px;" href="#"><b style="color: darkslategrey">PREGLEDAJ VRACENE KONTAKTE </b></a>

                                    </div>
                                </div>
                                <div class="col-4 text-end">
                                    <div class="icon icon-shape bg-gradient-warning shadow-warning text-center rounded-circle">
                                        <i class="ni ni-cart text-lg opacity-10" aria-hidden="true"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-12">
                    <div class="card  mb-4">
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-8">
                                    @if (User.IsInRole("adminsales"))
                                    {
                                       <div class="numbers">
                                           <p class="text-sm mb-0 text-uppercase font-weight-bold">Ukupno u pregovorima <u id="pregovorimaCount">@Model.uPregovorima.Count()</u></p>
                                           <a style="text-align: center; font-size: 14px;" href="#" onclick="openModal('pregovorimaModal')">PREGLEDAJ KONTAKTE</a>
                                           <p class="text-sm mb-0 text-uppercase font-weight-bold">Nisu zainteresovani <u id="nisuZainteresovaniCount">@Model.nisuZainteresovani.Count()</u></p>
                                           <a style="text-align: center; font-size: 14px;" href="#" onclick="openModal('nisuZainteresovaniModal')">PREGLEDAJ KONTAKTE</a>
                                           <p class="text-sm mb-0 text-uppercase font-weight-bold">Ukupno prodatih <u id="prodatiCount">@Model.prodati.Count()</u></p>
                                           <a style="text-align: center; font-size: 14px;" href="#" onclick="openModal('prodatiModal')">PREGLEDAJ KONTAKTE</a>
                                       </div>
                                    }
                                    else
                                    {
                                        <div class="numbers">
                                            <h6>STATISTIKA KORISNIKA</h6>
                                            <p class="text-sm mb-0 text-uppercase font-weight-bold">Ukupno u pregovorima <u>@Model.uPregovorimaUser.Count()</u></p>                                 
                                            <p class="text-sm mb-0 text-uppercase font-weight-bold">Ukupno prodatih <u>@Model.prodatiUser.Count()</u></p>
                                          
                                        </div>
                                    }

                                </div>
                                <div class="col-4 text-end">
                                    <div class="icon icon-shape bg-gradient-danger shadow-danger text-center rounded-circle">
                                        <i class="ni ni-world text-lg opacity-10" aria-hidden="true"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-5">
            <div class="card h-100 ">
                <div class="card-header">
                    <h5 class="mb-0 text-capitalize">Tvoji zakazani termini</h5>
                </div>
                <div class="card-body pt-0">
                    <ul class="list-group list-group-flush">
                        @if (Model.termini != null && Model.termini.Count > 0)
                        {
                            foreach (var value in Model.termini)
                            {
                                <li class="list-group-item px-0">
                                    <div class="row align-items-center">
                                        <b style=" padding-left: 0px; font-size:17px;"> @value.NAZIV</b>


                                    </div>

                                    <div class="row align-items-center">

                                        @value.DATUM


                                    </div>
                                    <div class="row align-items-lg-start">
                                        @if ((User.IsInRole("sales")))
                                        {
                                            <a style="text-align: center; font-size: 14px;" href="/Pregled/kontaktSales/@value.KONTAKT_ID"><b style="color: darkslategrey">PREGLEDAJ KONTAKT</b></a>

                                        }
                                        else
                                        {
                                            <a style="text-align: center; font-size: 14px;" href="/Pregled/Kontakt/@value.KONTAKT_ID"><b style="color: darkslategrey">PREGLEDAJ KONTAKT</b></a>

                                        }

                                    </div>
                                </li>
                                <hr />
                            }
                        }
                        else
                        {
                            <p>Nemate zakazanih termina.</p>
                        }
                    </ul>

                </div>
            </div>
        </div>
        <div class="col-lg-7 mb-4 mb-lg-0">
            <div class="card z-index-2 h-100">
                <div class="card-header pb-0 pt-3 bg-transparent">
                    <h6 class="text-capitalize">
                        Prikaz klijenata po mjesecima za
                        <script>
                            document.write(new Date().getFullYear())
                        </script>
                        god.
                    </h6>
                    <p class="text-sm mb-0">

                    </p>
                </div>
                <div class="card-body p-3">
                    <div class="chart">
                        <canvas id="chart-line" class="chart-canvas" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modals -->
        <div id="pregovorimaModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('pregovorimaModal')">&times;</span>           
                <table class="table table-flush" id="datatable-basic">
                    <thead class="thead-light">
                        <tr style="text-align:center;">
                            <th style="text-align:center;">Ime</th>
                            <th style="text-align:center;">Prezime</th>
                            <th style="text-align:center;">Adresa</th>
                            <th style="text-align:center;">Komentar</th>
                            <th style="text-align:center;">Agent</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var user in @Model.uPregovorima)
                        {
                            <tr>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.IME</td>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.PREZIME</td>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.ADRESA</td>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.KOMENTAR</td>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.AspNetUsers1.UserName</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div id="nisuZainteresovaniModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('nisuZainteresovaniModal')">&times;</span>            
                <table class="table table-flush" id="datatable-basic">
                    <thead class="thead-light">
                        <tr style="text-align:center;">
                            <th style="text-align:center;">Ime</th>
                            <th style="text-align:center;">Prezime</th>
                            <th style="text-align:center;">Adresa</th>
                            <th style="text-align:center;">Komentar</th>
                            <th style="text-align:center;">Agent</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var user in @Model.nisuZainteresovani)
                        {
                            <tr>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.IME</td>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.PREZIME</td>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.ADRESA</td>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.KOMENTAR</td>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.AspNetUsers1.UserName</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div id="prodatiModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('prodatiModal')">&times;</span>
                <table class="table table-flush" id="datatable-basic">
                    <thead class="thead-light">
                        <tr style="text-align:center;">
                            <th style="text-align:center;">Ime</th>
                            <th style="text-align:center;">Prezime</th>
                            <th style="text-align:center;">Adresa</th>
                            <th style="text-align:center;">Komentar</th>
                            <th style="text-align:center;">Agent</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var user in @Model.prodati)
                        {
                            <tr>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.IME</td>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.PREZIME</td>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.ADRESA</td>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.KOMENTAR</td>
                                <td style="text-align:center;" class="text-sm font-weight-normal">@user.AspNetUsers2.UserName</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<script src="~/Content/js/plugins/chartjs.min.js"></script>
<script>
    //modelData = [50, 40, 300, 220, 500, 250, 400, 230, 500];
    var modelData = @Html.Raw(Model.graphData);
    var countData = new Array(12).fill(0);
    modelData.forEach(function (item) {
        var date = new Date(item.Month + " 1");
        var monthIndex = date.getMonth();
        countData[monthIndex] = item.Count;
    });


    var ctx1 = document.getElementById("chart-line").getContext("2d");

    var gradientStroke1 = ctx1.createLinearGradient(0, 230, 0, 50);

    gradientStroke1.addColorStop(1, 'rgba(94, 114, 228, 0.2)');
    gradientStroke1.addColorStop(0.2, 'rgba(94, 114, 228, 0.0)');
    gradientStroke1.addColorStop(0, 'rgba(94, 114, 228, 0)');
    new Chart(ctx1, {
        type: "line",
        data: {
            labels: ["Jan","Feb","Mar","Apr", "Maj", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
            datasets: [{
                label: "Ukupno unjetih klijenata",
                tension: 0.4,
                borderWidth: 0,
                pointRadius: 0,
                borderColor: "#5e72e4",
                backgroundColor: gradientStroke1,
                borderWidth: 3,
                fill: true,
                data: countData,
                maxBarThickness: 6

            }],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                }
            },
            interaction: {
                intersect: false,
                mode: 'index',
            },
            scales: {
                y: {
                    grid: {
                        drawBorder: false,
                        display: true,
                        drawOnChartArea: true,
                        drawTicks: false,
                        borderDash: [5, 5]
                    },
                    ticks: {
                        display: true,
                        padding: 10,
                        color: '#fbfbfb',
                        font: {
                            size: 11,
                            family: "Open Sans",
                            style: 'normal',
                            lineHeight: 2
                        },
                    }
                },
                x: {
                    grid: {
                        drawBorder: false,
                        display: false,
                        drawOnChartArea: false,
                        drawTicks: false,
                        borderDash: [5, 5]
                    },
                    ticks: {
                        display: true,
                        color: '#ccc',
                        padding: 20,
                        font: {
                            size: 11,
                            family: "Open Sans",
                            style: 'normal',
                            lineHeight: 2
                        },
                    }
                },
            },
        },
    });

    function openModal(modalId) {
        var modal = document.getElementById(modalId);
        modal.style.display = "block";
    }

    function closeModal(modalId) {
        var modal = document.getElementById(modalId);
        modal.style.display = "none";
    }

    window.onclick = function (event) {
        // Close the modal when clicking outside of it
        if (event.target.className === "modal") {
            event.target.style.display = "none";
        }
    }

</script>